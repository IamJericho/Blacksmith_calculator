<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Internal Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#0e1117; color:#eaeaea }
    h1,h2,h3 { color:#ff4d4d }
    .table-zebra tbody tr:nth-child(odd) td { background:#0f141b!important }
    .table-zebra tbody tr:nth-child(even) td { background:#161b22!important }
    .table-zebra tbody tr:hover td { background:#1f2633!important }
    .category-row td {
      background:#0b0f14!important;
      font-weight:bold;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:#ff4d4d
    }
    .output {
      background:#161b22;
      padding:12px;
      border:1px solid #2a2f3a;
      margin-top:15px
    }
    pre { white-space:pre-wrap }
  </style>
</head>

<body class="container-fluid">

<h1>Internal Calculator</h1>

<h2>Regular Saddles</h2>
<table class="table table-dark table-sm table-zebra">
  <thead><tr><th>Item</th><th>Qty</th></tr></thead>
  <tbody id="regular"></tbody>
</table>

<h2>Platform Saddles</h2>
<table class="table table-dark table-sm table-zebra">
  <thead><tr><th>Item</th><th>Qty</th></tr></thead>
  <tbody id="platform"></tbody>
</table>

<h2>Tier 1</h2>
<table class="table table-dark table-sm table-zebra">
  <thead><tr><th>Item</th><th>Qty</th></tr></thead>
  <tbody id="tier1"></tbody>
</table>

<h2>Tier 2</h2>
<table class="table table-dark table-sm table-zebra">
  <thead><tr><th>Item</th><th>Qty</th></tr></thead>
  <tbody id="tier2"></tbody>
</table>

<h2>Cursed Tier 2</h2>
<p>(requires: LC Expansion)</p>
<table class="table table-dark table-sm table-zebra">
  <thead><tr><th>Item</th><th>Qty</th></tr></thead>
  <tbody id="cursed2"></tbody>
</table>

<div class="row g-2 mb-3">
  <div class="col-auto">
    <label class="form-label mb-0">Room</label>
    <select id="roomSelect" class="form-select form-select-sm">
      <option value="A">A</option>
      <option value="B">B</option>
    </select>
  </div>

  <div class="col-auto">
    <label class="form-label mb-0">Vault</label>
    <select id="vaultSelect" class="form-select form-select-sm">
      <option>1</option><option>2</option><option>3</option>
      <option>4</option><option>5</option><option>6</option><option>7</option>
    </select>
  </div>

  <div class="col-auto">
    <label class="form-label mb-0">Delivery</label>
    <select id="deliverySelect" class="form-select form-select-sm">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
  </div>

  <div class="col-auto" id="reinforceBox">
    <label class="form-label mb-0">Reinforce</label>
    <select id="reinforceSelect" class="form-select form-select-sm">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
  </div>
</div>

<div class="output">
  <h3>Material Totals</h3>
  <pre id="materialSummary"></pre>
</div>

<div class="output">
  <h3>Tek Split (70 / 30)</h3>
  <pre id="tekSplit"></pre>
</div>

<div class="output">
  <h3>Order Summary</h3>
  <pre id="orderSummary"></pre>
  <button class="btn btn-sm btn-primary" onclick="copyAll()">Copy All</button>
  <span id="copyMsg" style="margin-left:10px;color:#4caf50;display:none;">Copied!</span>
  <button class="btn btn-sm btn-secondary" onclick="resetAll()">Reset</button>
</div>

<script src="blacksmith.js"></script>
<script>

function qtySelect(group,name){
  return `<select class="form-select form-select-sm" data-group="${group}" data-name="${name}">
    ${Array.from({length:51},(_,i)=>`<option>${i}</option>`).join("")}
  </select>`;
}

function buildSimple(id,data){
  const t=document.getElementById(id);
  Object.keys(data).forEach(n=>{
    t.insertAdjacentHTML("beforeend",`<tr><td>${n}</td><td>${qtySelect(id,n)}</td></tr>`);
  });
}

function buildNested(id,data){
  const t=document.getElementById(id);
  Object.keys(data).forEach(cat=>{
    t.insertAdjacentHTML("beforeend",`<tr class="category-row"><td colspan="2">${cat}</td></tr>`);
    Object.keys(data[cat]).forEach(i=>{
      t.insertAdjacentHTML("beforeend",
        `<tr><td>${i}</td><td>${qtySelect(id,`${cat}|${i}`)}</td></tr>`);
    });
  });
}

buildSimple("regular",BLACKSMITH.saddles.regular);
buildSimple("platform",BLACKSMITH.saddles.platform);
buildNested("tier1",BLACKSMITH.equipment.tier1);
buildNested("tier2",BLACKSMITH.equipment.tier2);
buildNested("cursed2",BLACKSMITH.cursed.tier2);

document.addEventListener("change",calc);

function calc(){
  let totalTek=0,reinfTek=0,totalItems=0;
  let hasReinf=false;
  const mats={};
  const out={saddle:[],tier1:[],tier2:[],cursed2:[]};

  const reinforce=document.getElementById("reinforceSelect").value==="yes";

  document.querySelectorAll("select[data-group]").forEach(sel=>{
    const qty=+sel.value;
    if(!qty)return;
    totalItems+=qty;

    const g=sel.dataset.group,n=sel.dataset.name;
    let item,cat,name;

    if(g==="regular"||g==="platform"){
      item=BLACKSMITH.saddles[g][n];
      out.saddle.push(`${qty} ${n}`);
    } else {
      [cat,name]=n.split("|");
      item=(g==="cursed2")
        ? BLACKSMITH.cursed.tier2[cat][name]
        : BLACKSMITH.equipment[g][cat][name];

      if(cat==="weapons"||cat==="tools"||cat==="armor"){
        hasReinf=true;
        reinfTek+=Math.ceil(item.tek*qty*0.30);
      }
      out[g].push(`${qty} ${cat.toLowerCase()} â€“ ${name}`);
    }

    totalTek+=item.tek*qty;

    Object.entries(item.materials).forEach(([k,v])=>{
      const base=v*qty;
      mats[k]=(mats[k]||0)+base;
      if(reinforce && hasReinf){
        mats[k]+=Math.ceil(base*0.285);
      }
    });
  });

  const finalTek=totalTek+(reinforce?reinfTek:0);
  const farmer=Math.round(finalTek*0.70);
  const crafter=finalTek-farmer;

  document.getElementById("tekSplit").textContent=
`Total Tek: ${finalTek}
DTJ (70%): ${farmer}
NBP (30%): ${crafter}
${reinforce?`Reinforcement: ${reinfTek}`:""}`;

  document.getElementById("materialSummary").textContent=
Object.entries(mats).sort(([a],[b])=>a.localeCompare(b))
.map(([k,v])=>`${BLACKSMITH.materialsKey[k]||k}: ${v}`).join("\n");
}

function copyAll(){
  navigator.clipboard.writeText(
    document.getElementById("orderSummary").textContent
  ).then(()=>{
    const m=document.getElementById("copyMsg");
    m.style.display="inline";
    setTimeout(()=>m.style.display="none",1500);
  });
}

function resetAll(){
  document.querySelectorAll("select").forEach(s=>s.value=0);
  ["orderSummary","materialSummary","tekSplit"]
    .forEach(id=>document.getElementById(id).textContent="");
}

</script>
</body>
</html>
